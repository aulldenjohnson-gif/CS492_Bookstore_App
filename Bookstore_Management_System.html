<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bookstore Management System</title>
    <style>
        /* Simple styling for readability */
        body { font-family: Arial, sans-serif; padding: 20px; }
        h1, h2 { border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        form > * { margin-right: 10px; }
        .total-row td { font-weight: bold; background-color: #e6e6ff; }
      /* Accessibility / presentation classes */
      .low-stock-alert { color:#b33; font-weight:bold; margin-left:12px; display:none }
      .low-stock-row { background-color:#fff0f0 }
      .grand-total-cell { text-align: right }
      .threshold-input { width:70px }
    </style>
    <style id="receipt-generation-styles">
      /* Styles used for generated receipt content (PDF and popup) */
      .receipt-temp { font-family: Arial, sans-serif; max-width:700px; padding:16px; }
      .receipt-temp table { width:100%; border-collapse:collapse; }
      .receipt-temp th { text-align:left; padding:8px; border-bottom:1px solid #eee }
      .receipt-temp td { padding:8px; border-bottom:1px solid #eee }
      .receipt-temp .right { text-align:right }
      .receipt-temp .total { font-weight: bold; font-size:1.1em }
      .receipt-temp .small-muted { font-size:0.9em; color:#666 }
    </style>
    <!-- PDF export libraries: html2canvas and jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <h1>Bookstore Management System</h1>

    <h2>Add Book to Inventory</h2>
    <form id="bookForm">
      <label for="bookTitle">Title:</label>
      <input type="text" id="bookTitle" required title="Book title" placeholder="Book title">
      <label for="bookAuthor">Author:</label>
      <input type="text" id="bookAuthor" required title="Author name" placeholder="Author name">
      <label for="bookQty">Quantity:</label>
      <input type="number" id="bookQty" min="1" required title="Quantity" placeholder="1">
      <button type="submit">Add Book</button>
    </form>

    <hr>

    <h2>Current Inventory</h2>
    <p>
      <label for="lowStockThreshold">Low stock threshold:</label>
      <input type="number" id="lowStockThreshold" value="5" min="0" title="Low stock threshold" class="threshold-input">
      <span id="lowStockAlert" class="low-stock-alert"></span>
    </p>
    <table id="inventoryTable">
      </table>

    <hr>

    <h2>Place Customer Order</h2>
    <form id="orderForm">
      <label for="custName">Customer:</label>
      <input type="text" id="custName" required title="Customer name" placeholder="Customer name">
      <label for="orderBook">Book:</label>
      <input type="text" id="orderBook" required title="Book title" placeholder="Book title">
      <label for="orderQty">Quantity:</label>
      <input type="number" id="orderQty" min="1" required title="Order quantity" placeholder="1">
      <button type="submit">Place Order</button>
    </form>

    <hr>

    <h2>Customer Orders</h2>
    <p>
      <button type="button" id="printLastReceipt">Print Last Receipt</button>
      <button type="button" id="downloadLastReceipt">Download Last Receipt (PDF)</button>
    </p>
    <table id="ordersTable">
      </table>
    
    <hr>
    
    <h2>Create New Supplier Purchase Order</h2>
    <form id="purchaseOrderForm" onsubmit="event.preventDefault(); alert('Purchase Order submitted!');">
        <p>
          <label for="supplierName">Supplier:</label>
          <input type="text" id="supplierName" required title="Supplier name" placeholder="Supplier name">
          <label for="poDate">PO Date:</label>
          <input type="date" id="poDate" required title="Purchase order date">
        </p>
        <table id="itemTable">
            <thead>
                <tr>
                    <th>ISBN/Book ID</th>
                    <th>Quantity</th>
                    <th>Unit Cost</th>
                    <th>Line Total</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
            <tfoot>
                <tr class="total-row">
                  <td colspan="3" class="grand-total-cell">Grand Total:</td>
                  <td id="grandTotal">$0.00</td>
                  <td></td>
                </tr>
            </tfoot>
        </table>
        <button type="button" onclick="addItemRow()">Add Item</button>
        <button type="submit">Submit Purchase Order</button>
    </form>

    <script>
        // ðŸ“š Logic from Untitled-1.html (Inventory and Customer Orders)
        const inventory = [];
        const orders = [];

        // Helper function to re-render the inventory table
        function renderInventory() {
          const table = document.getElementById('inventoryTable');
          if (!table) return;
          const threshold = getLowStockThreshold();
          table.innerHTML = '<tr><th>Title</th><th>Author</th><th>Quantity</th></tr>';
          inventory.forEach(b => {
            const lowClass = (threshold !== null && b.qty <= threshold) ? ' style="background-color:#fff0f0"' : '';
            table.innerHTML += `<tr${lowClass}><td>${b.title}</td><td>${b.author}</td><td>${b.qty}</td></tr>`;
          });
        }

        // Helper function to re-render the orders table
        function renderOrders() {
          const table = document.getElementById('ordersTable');
          if (!table) return;
          table.innerHTML = '<tr><th>Customer</th><th>Book</th><th>Quantity</th></tr>';
          orders.forEach(o => {
            table.innerHTML += `<tr><td>${o.customer}</td><td>${o.book}</td><td>${o.qty}</td></tr>`;
          });
        }
        
        // Event handler for adding a new book and wiring up order form
        function getLowStockThreshold() {
          const el = document.getElementById('lowStockThreshold');
          if (!el) return null;
          const v = parseInt(el.value);
          return Number.isFinite(v) ? v : null;
        }

        function checkLowStock() {
          try {
            const threshold = getLowStockThreshold();
            const alertEl = document.getElementById('lowStockAlert');
            if (threshold === null || !alertEl) return;

            const lowItems = inventory.filter(b => b.qty <= threshold);
            if (lowItems.length === 0) {
              alertEl.style.display = 'none';
              alertEl.textContent = '';
            } else {
              alertEl.style.display = 'inline';
              const names = lowItems.map(i => `${i.title} (${i.qty})`);
              alertEl.textContent = 'Low stock: ' + names.join(', ');
            }
          } catch (err) {
            console.error('checkLowStock error:', err);
          }
        }

        window.addEventListener('DOMContentLoaded', function() {
          const bookForm = document.getElementById('bookForm');
          if (bookForm) {
            bookForm.onsubmit = function(e) {
              e.preventDefault();

              const title = document.getElementById('bookTitle').value;
              const author = document.getElementById('bookAuthor').value;
              const qty = parseInt(document.getElementById('bookQty').value);

              const existing = inventory.find(b => b.title.toLowerCase() === title.toLowerCase());
              if (existing) {
                existing.qty += qty;
              } else {
                inventory.push({ title, author, qty });
              }

              bookForm.reset();
              renderInventory();
              checkLowStock();
            }
          }

          // Event handler for placing a customer order
          const orderForm = document.getElementById('orderForm');
          if (orderForm) {
            orderForm.onsubmit = function(e) {
              e.preventDefault();

              const customer = document.getElementById('custName').value;
              const bookName = document.getElementById('orderBook').value;
              const qty = parseInt(document.getElementById('orderQty').value);

              const book = inventory.find(b => b.title.toLowerCase() === bookName.toLowerCase());
              if (!book) {
                alert('Book not found in inventory.');
                return;
              }
              if (book.qty < qty) {
                alert(`Not enough stock. Only ${book.qty} copies of ${bookName} available.`);
                return;
              }

              book.qty -= qty;
              orders.push({ customer, book: book.title, qty });

              orderForm.reset();
              renderInventory();
              renderOrders();
              checkLowStock();
              // Generate printable receipt for this order
              try {
                const newOrder = orders[orders.length - 1];
                generateReceipt(newOrder);
              } catch (err) {
                console.error('Receipt generation failed:', err);
              }
            }
          }

          // wire threshold input to update
          const thresholdInput = document.getElementById('lowStockThreshold');
          if (thresholdInput) {
            thresholdInput.addEventListener('input', () => {
              renderInventory();
              checkLowStock();
            });
          }

          // Initial render calls
          renderInventory();
          renderOrders();
          checkLowStock();
        });

        // Print / Generate receipt for last order
        document.addEventListener('DOMContentLoaded', () => {
          const btn = document.getElementById('printLastReceipt');
          if (btn) btn.addEventListener('click', () => {
            if (orders.length === 0) {
              alert('No orders yet to print.');
              return;
            }
            generateReceipt(orders[orders.length - 1]);
          });

          const dl = document.getElementById('downloadLastReceipt');
          if (dl) dl.addEventListener('click', async () => {
            if (orders.length === 0) {
              alert('No orders yet to download.');
              return;
            }
            try {
              await generateReceiptPDF(orders[orders.length - 1]);
            } catch (err) {
              console.error('PDF generation failed:', err);
              alert('PDF generation failed: ' + (err && err.message ? err.message : err));
            }
          });
        });

        // Receipt generation utility: opens a printable window with order details
        function generateReceipt(order) {
          if (!order) return;
          const now = new Date();
          const orderId = 'ORD-' + now.getTime();
          const receiptHtml = `<!doctype html>
            <html>
            <head>
              <meta charset="utf-8">
              <title>Receipt ${orderId}</title>
              <style>
                body { font-family: Arial, sans-serif; padding:20px; }
                .receipt { max-width:600px; margin:auto; border:1px solid #ddd; padding:16px }
                h2 { margin-top:0 }
                table { width:100%; border-collapse:collapse }
                td, th { padding:8px; border-bottom:1px solid #eee }
                .right { text-align:right }
                .total { font-weight: bold; font-size:1.1em }
                .small-muted { font-size:0.9em;color:#666 }
              </style>
            </head>
            <body>
              <div class="receipt">
                <h2>Bookstore Receipt</h2>
                <p>Order ID: <strong>${orderId}</strong><br>
                Date: ${now.toLocaleString()}</p>

                <table>
                  <tr><th>Customer</th><td>${escapeHtml(order.customer)}</td></tr>
                  <tr><th>Book</th><td>${escapeHtml(order.book)}</td></tr>
                  <tr><th>Quantity</th><td class="right">${order.qty}</td></tr>
                </table>

                <p class="right total">Items: ${order.qty}</p>

                <p>Thank you for your purchase!</p>
                <p class="small-muted">Please retain this receipt for your records.</p>
              </div>
              <script>
                // Auto-trigger print and close the window afterwards
                window.onload = function() {
                  setTimeout(function(){ window.print(); }, 250);
                };
              <\/script>
            </body>
            </html>`;

          const win = window.open('', '_blank', 'width=700,height=800');
          if (!win) {
            // Fallback: popup blocked â€” generate a PDF instead
            console.warn('Popup blocked when opening receipt window; falling back to PDF.');
            generateReceiptPDF(order).catch(err => console.error('Fallback PDF failed:', err));
            alert('Popup blocked. A PDF receipt will be downloaded instead.');
            return;
          }
          win.document.open();
          win.document.write(receiptHtml);
          win.document.close();
        }

        function escapeHtml(str) {
          if (!str) return '';
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        // Generate a PDF for the receipt using html2canvas + jsPDF
        async function generateReceiptPDF(order) {
          if (!order) return;

          // Build a DOM element for the receipt (kept offscreen)
          const container = document.createElement('div');
          container.style.position = 'fixed';
          container.style.left = '-9999px';
          container.style.top = '0';
          container.style.width = '700px';
          container.style.padding = '16px';
          container.className = 'receipt-temp';
          container.innerHTML = `
            <div class="receipt-temp">
              <h2>Bookstore Receipt</h2>
              <p>Order ID: <strong>${'TMP-' + Date.now()}</strong><br>
              Date: ${new Date().toLocaleString()}</p>
              <table>
                <tr><th>Customer</th><td>${escapeHtml(order.customer)}</td></tr>
                <tr><th>Book</th><td>${escapeHtml(order.book)}</td></tr>
                <tr><th>Quantity</th><td class="right">${order.qty}</td></tr>
              </table>
              <p class="right total">Items: ${order.qty}</p>
              <p>Thank you for your purchase!</p>
            </div>
          `;

          document.body.appendChild(container);

          try {
            // Render with html2canvas at higher scale for quality
            const canvas = await html2canvas(container, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');

            // Use jsPDF to create PDF and add the image
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ unit: 'pt', format: 'a4' });

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();

            // Calculate image dimensions to fit page width with aspect ratio
            const imgProps = pdf.getImageProperties(imgData);
            const imgWidth = pageWidth - 40; // margins
            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

            pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
            pdf.save(`receipt_${Date.now()}.pdf`);
          } finally {
            // Remove temp node
            container.remove();
          }
        }


        // ðŸ’° Logic from Purchase_Order_Form.js (Supplier PO and calculation)

        function formatCurrency(amount) {
            return `$${Number(amount).toFixed(2)}`;
        }

        function calculateLineTotal(rowOrElement) {
            const row = rowOrElement.tagName === 'TR' ? rowOrElement : rowOrElement.closest('tr');
            if (!row) return;

            const quantity = parseFloat(row.querySelector('.quantity')?.value) || 0;
            const cost = parseFloat(row.querySelector('.cost')?.value) || 0;
            const lineTotal = quantity * cost;

            const lineCell = row.querySelector('.line-total');
            if (lineCell) lineCell.textContent = formatCurrency(lineTotal);

            calculateGrandTotal();
        }

        function deleteItemRow(rowOrButton) {
            const row = rowOrButton.tagName === 'TR' ? rowOrButton : rowOrButton.closest('tr');
            if (!row) return;
            row.remove();
            calculateGrandTotal();
        }

        // Must be defined before addItemRow uses it
        function calculateGrandTotal() {
            let grandTotal = 0;
            // Select all line totals and sum them up
            document.querySelectorAll('.line-total').forEach(cell => {
                // Remove '$' before parsing to a number
                const totalValue = parseFloat(cell.textContent.replace('$', '')) || 0;
                grandTotal += totalValue;
            });

            const grandEl = document.getElementById('grandTotal');
            if (grandEl) grandEl.textContent = formatCurrency(grandTotal);
        }

        function addItemRow() {
            const tableBody = document.querySelector('#itemTable tbody');
            if (!tableBody) return;

            const newRow = tableBody.insertRow();

            // 1. ISBN/Book ID
            let cell1 = newRow.insertCell();
            cell1.innerHTML = '<input type="text" class="isbn" required title="ISBN or Book ID" placeholder="ISBN/Book ID" aria-label="ISBN or Book ID">';

            // 2. Quantity
            let cell2 = newRow.insertCell();
            cell2.innerHTML = '<input type="number" class="quantity" value="1" min="1" required title="Quantity" placeholder="Qty" aria-label="Quantity">';

            // 3. Unit Cost
            let cell3 = newRow.insertCell();
            cell3.innerHTML = '<input type="number" class="cost" value="0.00" min="0" step="0.01" required title="Unit cost" placeholder="0.00" aria-label="Unit cost">';

            // 4. Line Total (Read-only output)
            let cell4 = newRow.insertCell();
            cell4.classList.add('line-total');
            cell4.textContent = formatCurrency(0);

            // 5. Delete Button
            let cell5 = newRow.insertCell();
            // Pass the row directly to the delete function
            cell5.innerHTML = '<button type="button" class="delete-row">Delete</button>';

            // Attach event listeners
            const qtyInput = newRow.querySelector('.quantity');
            const costInput = newRow.querySelector('.cost');
            const deleteBtn = newRow.querySelector('.delete-row');

            const recalc = () => calculateLineTotal(newRow);
            qtyInput.addEventListener('input', recalc);
            costInput.addEventListener('input', recalc);
            deleteBtn.addEventListener('click', () => deleteItemRow(newRow));

            // Calculate initial line total
            calculateLineTotal(newRow);
        }

        // Add a default row when the page loads
        window.addEventListener('load', function() {
            try {
                const tableBody = document.querySelector('#itemTable tbody');
                if (tableBody && tableBody.querySelectorAll('tr').length === 0) {
                    addItemRow();
                }
            } catch(error) {
                console.error('Error initializing purchase order table:', error);
            }
        });
    </script>

</body>
</html>

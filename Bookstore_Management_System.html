<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bookstore Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #764ba2;
            font-size: 1.5em;
            margin-top: 35px;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        /* Form Styling */
        form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        label {
            display: inline-block;
            font-weight: 600;
            color: #555;
            margin-right: 10px;
            margin-bottom: 5px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="password"] {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        form button[type="submit"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        form button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button[type="button"] {
            background: #667eea;
            color: white;
            margin-top: 10px;
        }

        button[type="button"]:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.3);
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        td {
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 15px;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .total-row {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-weight: bold;
            font-size: 1.1em;
        }

        .total-row td {
            padding: 15px;
            color: #333;
        }

        /* Low Stock Alert */
        .low-stock-alert {
            color: #d32f2f;
            font-weight: bold;
            background: #ffebee;
            padding: 12px 15px;
            border-radius: 6px;
            margin-left: 12px;
            display: none;
            border-left: 4px solid #d32f2f;
        }

        .low-stock-row {
            background-color: #ffebee !important;
        }

        .grand-total-cell {
            text-align: right;
        }

        .threshold-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }

        /* Receipt Styles */
        .receipt-temp {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 700px;
            padding: 16px;
            background: white;
            border-radius: 8px;
        }

        .receipt-temp table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .receipt-temp th {
            text-align: left;
            padding: 10px;
            border-bottom: 2px solid #667eea;
            background: #f5f7fa;
            color: #333;
        }

        .receipt-temp td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .receipt-temp .right {
            text-align: right;
        }

        .receipt-temp .total {
            font-weight: bold;
            font-size: 1.1em;
            color: #667eea;
        }

        .receipt-temp .small-muted {
            font-size: 0.9em;
            color: #999;
        }

        /* Info Section */
        p {
            margin-bottom: 15px;
            font-size: 1.05em;
        }

        hr {
            border: none;
            height: 2px;
            background: linear-gradient(90deg, #667eea 0%, transparent 100%);
            margin: 30px 0;
        }

        /* Cancel Button in Tables */
        .cancel-btn {
            background-color: #d32f2f !important;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .cancel-btn:hover {
            background-color: #b71c1c !important;
            transform: scale(1.05);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.2em;
            }

            form {
                padding: 15px;
            }

            input, button {
                width: 100%;
                margin-bottom: 10px;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
    <!-- PDF export libraries: html2canvas and jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <div class="container">
        <h1>ðŸ“š Bookstore Management System</h1>

    <h2>Add Book to Inventory</h2>
    <form id="bookForm">
      <label for="bookTitle">Title:</label>
      <input type="text" id="bookTitle" required title="Book title" placeholder="Book title">
      <label for="bookAuthor">Author:</label>
      <input type="text" id="bookAuthor" required title="Author name" placeholder="Author name">
      <label for="bookQty">Quantity:</label>
      <input type="number" id="bookQty" min="1" required title="Quantity" placeholder="1">
      <button type="submit">Add Book</button>
    </form>

    <hr>

    <h2>Current Inventory</h2>
    <p>
      <label for="lowStockThreshold">Low stock threshold:</label>
      <input type="number" id="lowStockThreshold" value="5" min="0" title="Low stock threshold" class="threshold-input">
      <span id="lowStockAlert" class="low-stock-alert"></span>
    </p>
    <table id="inventoryTable">
      </table>

    <hr>

    <h2>Place Customer Order</h2>
    <form id="orderForm">
      <label for="custName">Customer:</label>
      <input type="text" id="custName" required title="Customer name" placeholder="Customer name">
      <label for="orderBook">Book:</label>
      <input type="text" id="orderBook" required title="Book title" placeholder="Book title">
      <label for="orderQty">Quantity:</label>
      <input type="number" id="orderQty" min="1" required title="Order quantity" placeholder="1">
      <button type="submit">Place Order</button>
    </form>

    <hr>

    <h2>Customer Orders</h2>
    <p>
      <button type="button" id="printLastReceipt">Print Last Receipt</button>
      <button type="button" id="downloadLastReceipt">Download Last Receipt (PDF)</button>
    </p>
    <table id="ordersTable">
      </table>
    
    <hr>
    
    <h2>Create New Supplier Purchase Order</h2>
    <form id="purchaseOrderForm" onsubmit="event.preventDefault(); submitSupplierOrder();">
        <p>
          <label for="supplierName">Supplier:</label>
          <input type="text" id="supplierName" required title="Supplier name" placeholder="Supplier name">
          <label for="poDate">PO Date:</label>
          <input type="date" id="poDate" required title="Purchase order date">
        </p>
        <table id="itemTable">
            <thead>
                <tr>
                    <th>ISBN/Book ID</th>
                    <th>Quantity</th>
                    <th>Unit Cost</th>
                    <th>Line Total</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
            <tfoot>
                <tr class="total-row">
                  <td colspan="3" class="grand-total-cell">Grand Total:</td>
                  <td id="grandTotal">$0.00</td>
                  <td></td>
                </tr>
            </tfoot>
        </table>
        <button type="button" onclick="addItemRow()">Add Item</button>
        <button type="submit">Submit Purchase Order</button>
    </form>

    <hr>

    <h2>Supplier Order History</h2>
    <div style="margin-bottom: 15px;">
        <button type="button" class="filter-btn" onclick="filterSupplierOrders('all')" style="padding: 8px 15px; margin-right: 5px; cursor: pointer;">All Orders</button>
        <button type="button" class="filter-btn" onclick="filterSupplierOrders('pending')" style="padding: 8px 15px; margin-right: 5px; cursor: pointer;">Pending</button>
        <button type="button" class="filter-btn" onclick="filterSupplierOrders('received')" style="padding: 8px 15px; cursor: pointer;">Received</button>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>PO ID</th>
                <th>Supplier Name</th>
                <th>PO Date</th>
                <th>Total</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="supplierOrderHistoryBody">
            <tr><td colspan="6" style="text-align:center;padding:15px;">Loading...</td></tr>
        </tbody>
    </table>

    <script>
        // ðŸ“š Logic from Untitled-1.html (Inventory and Customer Orders)
        const inventory = [];
        const orders = [];

        // Helper function to re-render the inventory table
        function renderInventory() {
          const table = document.getElementById('inventoryTable');
          if (!table) return;
          const threshold = getLowStockThreshold();
          table.innerHTML = '<tr><th>Title</th><th>Author</th><th>Quantity</th></tr>';
          inventory.forEach(b => {
            const lowClass = (threshold !== null && b.qty <= threshold) ? ' style="background-color:#fff0f0"' : '';
            table.innerHTML += `<tr${lowClass}><td>${b.title}</td><td>${b.author}</td><td>${b.qty}</td></tr>`;
          });
        }

        // Helper function to re-render the orders table
        function renderOrders() {
          const table = document.getElementById('ordersTable');
          if (!table) return;
          table.innerHTML = '<tr><th>Order ID</th><th>Customer</th><th>Book</th><th>Quantity</th><th>Status</th><th>Action</th></tr>';
          orders.forEach(o => {
            const statusClass = o.status === 'Cancelled' ? ' style="background-color:#ffcccc"' : '';
            const cancelBtn = o.status === 'Active' 
              ? `<button type="button" onclick="cancelOrderById(${o.order_id})" style="background-color:#ff6b6b; color:white; padding:5px 10px; border:none; cursor:pointer;">Cancel</button>`
              : '<span style="color:gray;">-</span>';
            table.innerHTML += `<tr${statusClass}><td>${o.order_id || 'N/A'}</td><td>${o.customer || o.customer_name}</td><td>${o.book}</td><td>${o.qty}</td><td>${o.status}</td><td>${cancelBtn}</td></tr>`;
          });
        }
        
        // Cancel an order by ID
        async function cancelOrderById(orderId) {
          try {
            const response = await fetch(`/api/orders/${orderId}/cancel`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            
            if (result.success) {
              alert(`Order ${orderId} has been cancelled.`);
              // Update local order status
              const order = orders.find(o => o.order_id === orderId);
              if (order) order.status = 'Cancelled';
              renderOrders();
            } else {
              alert(`Error: ${result.message}`);
            }
          } catch (err) {
            console.error('Failed to cancel order:', err);
            alert('Failed to cancel order. Please try again.');
          }
        }
        
        // Fetch inventory from backend API
        async function fetchInventoryFromAPI() {
          try {
            const response = await fetch('/api/inventory');
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const apiInventory = await response.json();
            
            // Convert API format to internal format
            inventory.length = 0; // Clear existing
            apiInventory.forEach(item => {
              inventory.push({
                title: item.title,
                author: item.book_id, // Use book_id as author placeholder
                qty: item.quantity,
                book_id: item.book_id
              });
            });
            
            renderInventory();
            checkLowStock();
          } catch (err) {
            console.error('Failed to fetch inventory from API:', err);
            // Continue with in-memory inventory as fallback
          }
        }
        
        // Fetch low stock alerts from backend
        async function fetchLowStockAlerts(threshold) {
          try {
            const response = await fetch(`/api/inventory/low-stock?threshold=${threshold}`);
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const data = await response.json();
            return data.items;
          } catch (err) {
            console.error('Failed to fetch low stock alerts:', err);
            return [];
          }
        }
        
        // Event handler for adding a new book and wiring up order form
        function getLowStockThreshold() {
          const el = document.getElementById('lowStockThreshold');
          if (!el) return null;
          const v = parseInt(el.value);

          return Number.isFinite(v) ? v : null;
        }

        function checkLowStock() {
          try {
            const threshold = getLowStockThreshold();
            const alertEl = document.getElementById('lowStockAlert');
            if (threshold === null || !alertEl) return;

            const lowItems = inventory.filter(b => b.qty <= threshold);
            if (lowItems.length === 0) {
              alertEl.style.display = 'none';
              alertEl.textContent = '';
            } else {
              alertEl.style.display = 'inline';
              const names = lowItems.map(i => `${i.title} (${i.qty})`);
              alertEl.textContent = 'Low stock: ' + names.join(', ');
            }
          } catch (err) {
            console.error('checkLowStock error:', err);
          }
        }

        window.addEventListener('DOMContentLoaded', function() {
          // Load inventory from API first
          fetchInventoryFromAPI();
          
          const bookForm = document.getElementById('bookForm');
          if (bookForm) {
            bookForm.onsubmit = function(e) {
              e.preventDefault();

              const title = document.getElementById('bookTitle').value;
              const author = document.getElementById('bookAuthor').value;
              const qty = parseInt(document.getElementById('bookQty').value);

              const existing = inventory.find(b => b.title.toLowerCase() === title.toLowerCase());
              if (existing) {
                existing.qty += qty;
              } else {
                inventory.push({ title, author, qty });
              }

              bookForm.reset();
              renderInventory();
              checkLowStock();
            }
          }

          // Event handler for placing a customer order
          const orderForm = document.getElementById('orderForm');
          if (orderForm) {
            orderForm.onsubmit = async function(e) {
              e.preventDefault();

              const customer = document.getElementById('custName').value;
              const bookName = document.getElementById('orderBook').value;
              const qty = parseInt(document.getElementById('orderQty').value);

              const book = inventory.find(b => b.title.toLowerCase() === bookName.toLowerCase());
              if (!book) {
                alert('Book not found in inventory.');
                return;
              }
              if (book.qty < qty) {
                alert(`Not enough stock. Only ${book.qty} copies of ${bookName} available.`);
                return;
              }

              // Create order via API
              try {
                const response = await fetch('/api/orders', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    customer_name: customer,
                    items: [{ book: bookName, quantity: qty }]
                  })
                });
                const result = await response.json();
                
                if (result.success) {
                  book.qty -= qty;
                  const orderData = {
                    order_id: result.order_id,
                    customer: customer,
                    customer_name: customer,
                    book: bookName,
                    qty: qty,
                    status: 'Active'
                  };
                  orders.push(orderData);

                  orderForm.reset();
                  renderInventory();
                  renderOrders();
                  checkLowStock();
                  
                  // Generate printable receipt for this order
                  try {
                    generateReceipt(orderData);
                  } catch (err) {
                    console.error('Receipt generation failed:', err);
                  }
                } else {
                  alert(`Error: ${result.message}`);
                }
              } catch (err) {
                console.error('Failed to create order:', err);
                alert('Failed to create order. Please try again.');
              }
            }
          }

          // wire threshold input to update
          const thresholdInput = document.getElementById('lowStockThreshold');
          if (thresholdInput) {
            thresholdInput.addEventListener('input', () => {
              renderInventory();
              checkLowStock();
            });
          }

          // Initial render calls
          renderInventory();
          renderOrders();
          checkLowStock();
        });

        // Print / Generate receipt for last order
        document.addEventListener('DOMContentLoaded', () => {
          const btn = document.getElementById('printLastReceipt');
          if (btn) btn.addEventListener('click', () => {
            if (orders.length === 0) {
              alert('No orders yet to print.');
              return;
            }
            generateReceipt(orders[orders.length - 1]);
          });

          const dl = document.getElementById('downloadLastReceipt');
          if (dl) dl.addEventListener('click', async () => {
            if (orders.length === 0) {
              alert('No orders yet to download.');
              return;
            }
            try {
              await generateReceiptPDF(orders[orders.length - 1]);
            } catch (err) {
              console.error('PDF generation failed:', err);
              alert('PDF generation failed: ' + (err && err.message ? err.message : err));
            }
          });
        });

        // Receipt generation utility: opens a printable window with order details
        function generateReceipt(order) {
          if (!order) return;
          const now = new Date();
          const orderId = 'ORD-' + now.getTime();
          const receiptHtml = `<!doctype html>
            <html>
            <head>
              <meta charset="utf-8">
              <title>Receipt ${orderId}</title>
              <style>
                body { font-family: Arial, sans-serif; padding:20px; }
                .receipt { max-width:600px; margin:auto; border:1px solid #ddd; padding:16px }
                h2 { margin-top:0 }
                table { width:100%; border-collapse:collapse }
                td, th { padding:8px; border-bottom:1px solid #eee }
                .right { text-align:right }
                .total { font-weight: bold; font-size:1.1em }
                .small-muted { font-size:0.9em;color:#666 }
              </style>
            </head>
            <body>
              <div class="receipt">
                <h2>Bookstore Receipt</h2>
                <p>Order ID: <strong>${orderId}</strong><br>
                Date: ${now.toLocaleString()}</p>

                <table>
                  <tr><th>Customer</th><td>${escapeHtml(order.customer)}</td></tr>
                  <tr><th>Book</th><td>${escapeHtml(order.book)}</td></tr>
                  <tr><th>Quantity</th><td class="right">${order.qty}</td></tr>
                </table>

                <p class="right total">Items: ${order.qty}</p>

                <p>Thank you for your purchase!</p>
                <p class="small-muted">Please retain this receipt for your records.</p>
              </div>
              <script>
                // Auto-trigger print and close the window afterwards
                window.onload = function() {
                  setTimeout(function(){ window.print(); }, 250);
                };
              <\/script>
            </body>
            </html>`;

          const win = window.open('', '_blank', 'width=700,height=800');
          if (!win) {
            // Fallback: popup blocked â€” generate a PDF instead
            console.warn('Popup blocked when opening receipt window; falling back to PDF.');
            generateReceiptPDF(order).catch(err => console.error('Fallback PDF failed:', err));
            alert('Popup blocked. A PDF receipt will be downloaded instead.');
            return;
          }
          win.document.open();
          win.document.write(receiptHtml);
          win.document.close();
        }

        function escapeHtml(str) {
          if (!str) return '';
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        // Generate a PDF for the receipt using html2canvas + jsPDF
        async function generateReceiptPDF(order) {
          if (!order) return;

          // Build a DOM element for the receipt (kept offscreen)
          const container = document.createElement('div');
          container.style.position = 'fixed';
          container.style.left = '-9999px';
          container.style.top = '0';
          container.style.width = '700px';
          container.style.padding = '16px';
          container.className = 'receipt-temp';
          container.innerHTML = `
            <div class="receipt-temp">
              <h2>Bookstore Receipt</h2>
              <p>Order ID: <strong>${'TMP-' + Date.now()}</strong><br>
              Date: ${new Date().toLocaleString()}</p>
              <table>
                <tr><th>Customer</th><td>${escapeHtml(order.customer)}</td></tr>
                <tr><th>Book</th><td>${escapeHtml(order.book)}</td></tr>
                <tr><th>Quantity</th><td class="right">${order.qty}</td></tr>
              </table>
              <p class="right total">Items: ${order.qty}</p>
              <p>Thank you for your purchase!</p>
            </div>
          `;

          document.body.appendChild(container);

          try {
            // Render with html2canvas at higher scale for quality
            const canvas = await html2canvas(container, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');

            // Use jsPDF to create PDF and add the image
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ unit: 'pt', format: 'a4' });

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();

            // Calculate image dimensions to fit page width with aspect ratio
            const imgProps = pdf.getImageProperties(imgData);
            const imgWidth = pageWidth - 40; // margins
            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

            pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
            pdf.save(`receipt_${Date.now()}.pdf`);
          } finally {
            // Remove temp node
            container.remove();
          }
        }


        // ðŸ’° Logic from Purchase_Order_Form.js (Supplier PO and calculation)

        function formatCurrency(amount) {
            return `$${Number(amount).toFixed(2)}`;
        }

        function calculateLineTotal(rowOrElement) {
            const row = rowOrElement.tagName === 'TR' ? rowOrElement : rowOrElement.closest('tr');
            if (!row) return;

            const quantity = parseFloat(row.querySelector('.quantity')?.value) || 0;
            const cost = parseFloat(row.querySelector('.cost')?.value) || 0;
            const lineTotal = quantity * cost;

            const lineCell = row.querySelector('.line-total');
            if (lineCell) lineCell.textContent = formatCurrency(lineTotal);

            calculateGrandTotal();
        }

        function deleteItemRow(rowOrButton) {
            const row = rowOrButton.tagName === 'TR' ? rowOrButton : rowOrButton.closest('tr');
            if (!row) return;
            row.remove();
            calculateGrandTotal();
        }

        // Must be defined before addItemRow uses it
        function calculateGrandTotal() {
            let grandTotal = 0;
            // Select all line totals and sum them up
            document.querySelectorAll('.line-total').forEach(cell => {
                // Remove '$' before parsing to a number
                const totalValue = parseFloat(cell.textContent.replace('$', '')) || 0;
                grandTotal += totalValue;
            });

            const grandEl = document.getElementById('grandTotal');
            if (grandEl) grandEl.textContent = formatCurrency(grandTotal);
        }

        function addItemRow() {
            const tableBody = document.querySelector('#itemTable tbody');
            if (!tableBody) return;

            const newRow = tableBody.insertRow();

            // 1. ISBN/Book ID
            let cell1 = newRow.insertCell();
            cell1.innerHTML = '<input type="text" class="isbn" required title="ISBN or Book ID" placeholder="ISBN/Book ID" aria-label="ISBN or Book ID">';

            // 2. Quantity
            let cell2 = newRow.insertCell();
            cell2.innerHTML = '<input type="number" class="quantity" value="1" min="1" required title="Quantity" placeholder="Qty" aria-label="Quantity">';

            // 3. Unit Cost
            let cell3 = newRow.insertCell();
            cell3.innerHTML = '<input type="number" class="cost" value="0.00" min="0" step="0.01" required title="Unit cost" placeholder="0.00" aria-label="Unit cost">';

            // 4. Line Total (Read-only output)
            let cell4 = newRow.insertCell();
            cell4.classList.add('line-total');
            cell4.textContent = formatCurrency(0);

            // 5. Delete Button
            let cell5 = newRow.insertCell();
            // Pass the row directly to the delete function
            cell5.innerHTML = '<button type="button" class="delete-row">Delete</button>';

            // Attach event listeners
            const qtyInput = newRow.querySelector('.quantity');
            const costInput = newRow.querySelector('.cost');
            const deleteBtn = newRow.querySelector('.delete-row');

            const recalc = () => calculateLineTotal(newRow);
            qtyInput.addEventListener('input', recalc);
            costInput.addEventListener('input', recalc);
            deleteBtn.addEventListener('click', () => deleteItemRow(newRow));

            // Calculate initial line total
            calculateLineTotal(newRow);
        }

        // Add a default row when the page loads
        window.addEventListener('load', function() {
            try {
                const tableBody = document.querySelector('#itemTable tbody');
                if (tableBody && tableBody.querySelectorAll('tr').length === 0) {
                    addItemRow();
                }
                // Load supplier order history
                fetchSupplierOrders('all');
            } catch(error) {
                console.error('Error initializing purchase order table:', error);
            }
        });

        // ===== SUPPLIER ORDER HISTORY FUNCTIONS =====
        async function fetchSupplierOrders(filter = 'all') {
            try {
                let endpoint = '/api/supplier-orders';
                if (filter === 'pending') {
                    endpoint = '/api/supplier-orders/pending';
                } else if (filter === 'received') {
                    endpoint = '/api/supplier-orders/received';
                }

                const response = await fetch(endpoint);
                if (!response.ok) {
                    console.error('Error fetching supplier orders:', response.statusText);
                    return;
                }

                const data = await response.json();
                const orders = data.orders || [];
                renderSupplierOrderHistory(orders);
            } catch (error) {
                console.error('Error fetching supplier orders:', error);
            }
        }

        function renderSupplierOrderHistory(orders) {
            const container = document.getElementById('supplierOrderHistoryBody');
            if (!container) return;

            container.innerHTML = '';

            if (orders.length === 0) {
                container.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:15px;">No supplier orders found</td></tr>';
                return;
            }

            orders.forEach(order => {
                const row = document.createElement('tr');
                
                // Status color coding
                const statusColor = order.status === 'Pending' ? 'background-color:#fffacd' : 'background-color:#e8f5e9';
                row.style.cssText = statusColor;

                // Build action buttons
                let actionButtons = '';
                if (order.status === 'Pending') {
                    actionButtons = `<button type="button" class="action-btn" onclick="markSupplierOrderReceived(${order.po_id})" style="margin-right:5px;">Receive</button><button type="button" class="action-btn" onclick="cancelSupplierOrder(${order.po_id})" style="background-color:#ff6b6b;">Cancel</button>`;
                } else {
                    actionButtons = '<span style="color:#666;">â€”</span>';
                }

                row.innerHTML = `
                    <td>${order.po_id}</td>
                    <td>${order.supplier_name}</td>
                    <td>${order.po_date}</td>
                    <td>${formatCurrency(order.total)}</td>
                    <td><strong>${order.status}</strong></td>
                    <td>${actionButtons}</td>
                `;

                container.appendChild(row);
            });
        }

        async function markSupplierOrderReceived(poId) {
            try {
                const response = await fetch(`/api/supplier-orders/${poId}/receive`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                if (!response.ok) {
                    console.error('Error marking order as received');
                    return;
                }

                // Refresh the display
                fetchSupplierOrders('all');
                alert(`Purchase Order #${poId} marked as received! Inventory updated.`);
            } catch (error) {
                console.error('Error marking order as received:', error);
            }
        }

        async function cancelSupplierOrder(poId) {
            if (!confirm(`Are you sure you want to cancel Purchase Order #${poId}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/supplier-orders/${poId}/cancel`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    alert('Error cancelling order: ' + (errorData.message || 'Unknown error'));
                    return;
                }

                // Refresh the display
                fetchSupplierOrders('all');
                alert(`Purchase Order #${poId} cancelled!`);
            } catch (error) {
                console.error('Error cancelling order:', error);
            }
        }

        async function submitSupplierOrder() {
            try {
                const supplierName = document.getElementById('supplierName').value.trim();
                const poDate = document.getElementById('poDate').value;

                if (!supplierName || !poDate) {
                    alert('Please fill in all required fields');
                    return;
                }

                // Collect items from the table
                const tableBody = document.querySelector('#itemTable tbody');
                const rows = tableBody.querySelectorAll('tr');

                if (rows.length === 0) {
                    alert('Please add at least one item to the purchase order');
                    return;
                }

                const items = [];
                rows.forEach(row => {
                    const cells = row.querySelectorAll('input');
                    if (cells.length >= 3) {
                        const isbn = cells[0].value.trim();
                        const qty = parseInt(cells[1].value);
                        const cost = parseFloat(cells[2].value);

                        if (isbn && qty > 0 && cost > 0) {
                            items.push({
                                isbn: isbn,
                                quantity: qty,
                                unit_cost: cost,
                                line_total: qty * cost
                            });
                        }
                    }
                });

                if (items.length === 0) {
                    alert('Please ensure all items have valid data');
                    return;
                }

                // Calculate total from grand total display
                const grandTotalText = document.getElementById('grandTotal').textContent;
                const total = parseFloat(grandTotalText.replace('$', '').replace(/,/g, ''));

                // Submit the order
                const response = await fetch('/api/supplier-orders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        supplier_name: supplierName,
                        po_date: poDate,
                        items: items,
                        total: total
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    alert('Error creating purchase order: ' + (errorData.message || 'Unknown error'));
                    return;
                }

                const result = await response.json();
                alert(`Purchase Order #${result.po_id} created successfully!`);

                // Reset the form
                document.getElementById('purchaseOrderForm').reset();
                document.querySelector('#itemTable tbody').innerHTML = '';
                addItemRow();

                // Refresh supplier order history
                fetchSupplierOrders('all');
            } catch (error) {
                console.error('Error submitting purchase order:', error);
                alert('Error submitting purchase order');
            }
        }

        function filterSupplierOrders(filter) {
            fetchSupplierOrders(filter);
        }
    </script>

    </div>
</body>
</html>
